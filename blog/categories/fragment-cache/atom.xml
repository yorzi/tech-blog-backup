<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">

  <title><![CDATA[Category: fragment-cache | @yorzi]]></title>
  <link href="http://yorzi.github.com/blog/categories/fragment-cache/atom.xml" rel="self"/>
  <link href="http://yorzi.github.com/"/>
  <updated>2012-10-23T13:28:00+08:00</updated>
  <id>http://yorzi.github.com/</id>
  <author>
    <name><![CDATA[Andy Wang]]></name>
    <email><![CDATA[wangyaodi@gmail.com]]></email>
  </author>
  <generator uri="http://octopress.org/">Octopress</generator>

  
  <entry>
    <title type="html"><![CDATA[Performance Practice On Rails]]></title>
    <link href="http://yorzi.github.com/2010/03/14/performance-practice-on-rails/"/>
    <updated>2010-03-14T00:00:00+08:00</updated>
    <id>http://yorzi.github.com/2010/03/14/performance-practice-on-rails</id>
    <content type="html"><![CDATA[<p>﻿﻿﻿﻿Last few days, I've been mainly struggling with performance issue which was sent to me on Monday. On Rails side, I didn't add enough necessary cache before I was told about the performance issue. Then I spent two days to improve it by adding cache every where I missed to do that before.</p>

<p>Some shares and confusions as below:</p>

<p>Shares:
1> A very useful educational website about scaling Rails where there are <a href="http://railslab.newrelic.com/2009/01/22/introduction">Scaling Rails Screencast Series</a> produced by Gregg Pollack and supported by New Relic.
2> Fragment cache.</p>

<pre><code>  If you add many fragment cache in view, it's really a pain when you expire your cache, so I found there is a better way to expire your cache: if the cached block involves a model, for example, learner's sidebar involves "User" model's change, so I just name the cache with User model's "updated_at", so I don't need to expire this cache, it will be done automatically.
</code></pre>

<p><code lang="ruby">
  &lt;% cache("sidebar-profile-avatar-#{current_user.id}-#{current_user.updated_at.to_i}") do -%></p>

<pre><code>&lt;div class="sbb_title"&gt;&lt;%= t :my_profile %&gt;&lt;/div&gt;
&lt;div class="sbb_content"&gt;
  &lt;table border="0" cellspacing="0" cellpadding="0" class="profile_table"&gt;
    &lt;tr&gt;
      &lt;td width="100" rowspan="2" align="center" valign="top"&gt;
        &lt;img src="&lt;%= current_user.avatar_url || "/assets/images/portrait_demo.gif" %&gt;" width="90" height="90" /&gt;
      &lt;/td&gt;
      &lt;td width="110" height="24"&gt;&lt;%= display_learner([current_user], nil) %&gt;&lt;/td&gt;
    &lt;/tr&gt;
    &lt;tr&gt;
      &lt;td valign="top"&gt;&lt;strong&gt;&lt;%= t :my_goal %&gt;&lt;/strong&gt;&lt;%= display_oral_score(current_user.try(:study_info).try(:target_score)) %&gt;&lt;/td&gt;
    &lt;/tr&gt;
  &lt;/table&gt;
&lt;% end -%&gt;
</code></pre>

<p></code>
3> Memcached. Cache whatever you want:
<code lang="ruby">
  def related_lessons</p>

<pre><code>cache_key = "related_lessons_for_item#{self.id}"
return Rails.cache.read(cache_key) unless Rails.cache.read(cache_key).nil?
if content_type == "Scenario"
  lessons = unit.extra_items.all(:conditions =&gt; {:content_id =&gt; content.extra_lessons.map(&amp;:id)})
elsif content_type == "ExtraLesson"
  lessons = [content.scenario.try(:item)]
end
Rails.cache.write(cache_key, lessons)
return lessons
</code></pre>

<p>  end
</code></p>

<p>Confusions:
1> It takes much time to render a partial view. that's pretty confusing to me. Some logs as below:
<code lang="ruby">
Cached fragment hit: views/sidebar-profile-roadmap-1268271150 (0.9ms)
Rendered shared/_sidebar_profile (109.8ms)
</code>
It seems like even the cached fragment is found, there still needs much time to render the partial..</p>

<p>2> From the log, I saw every request to "roadmap" index action will do the following stuff first, It's slow. But what that?
<code lang="ruby">
&lt;actionView::Base:0xb5a0e348>#&lt;actionView::Base:0xb5a0e348>#&lt;actionView::Base:0xb5a0e348>#&lt;actionView::Base:0xb5a0e348>#&lt;actionView::Base:0xb5a0e348>#&lt;actionView::Base:0xb5a0e348>#&lt;actionView::Base:0xb5a0e348>#&lt;actionView::Base:0xb5a0e348>#&lt;actionView::Base:0xb5a0e348>#&lt;actionView::Base:0xb5a0e348>#&lt;actionView::Base:0xb5a0e348>#&lt;actionView::Base:0xb5a0e348>#&lt;actionView::Base:0xb5a0e348>#&lt;actionView::Base:0xb5a0e348>#&lt;actionView::Base:0xb5a0e348>#&lt;actionView::Base:0xb5a0e348>#&lt;actionView::Base:0xb5a0e348>#&lt;actionView::Base:0xb5a0e348>#&lt;actionView::Base:0xb5a0e348>#&lt;actionView::Base:0xb5a0e348>#&lt;actionView::Base:0xb5a0e348>#&lt;actionView::Base:0xb5a0e348>#&lt;actionView::Base:0xb5a0e348>#&lt;actionView::Base:0xb5a0e348>#&lt;actionView::Base:0xb5a0e348>#&lt;actionView::Base:0xb5a0e348>#&lt;actionView::Base:0xb5a0e348>#&lt;actionView::Base:0xb5a0e348>#&lt;actionView::Base:0xb5a0e348>#&lt;actionView::Base:0xb5a0e348>#&lt;actionView::Base:0xb5a0e348>#&lt;actionView::Base:0xb5a0e348>#&lt;actionView::Base:0xb5a0e348>#&lt;actionView::Base:0xb5a0e348>#&lt;actionView::Base:0xb5a0e348>#&lt;actionView::Base:0xb5a0e348>#
</code></p>

<p>Any ideas on my confusions? All the involving clues are warmly welcomed.</p>
]]></content>
  </entry>
  
</feed>
